<%# views/admin/blog/_form-fields.ejs %>

<% if (typeof errors !== 'undefined' && errors && errors.length > 0) { %>
    <div class="alert alert-danger admin-alert">
        <strong>Помилка!</strong> Будь ласка, виправте наступні недоліки:
        <ul>
            <% errors.forEach(error => { %>
                <li><%= error.msg %></li>
            <% }); %>
        </ul>
    </div>
<% } %>

<div class="admin-form-group">
    <label for="title">Заголовок статті <span class="required">*</span></label>
    <input type="text" id="title" name="title" class="admin-form-control" value="<%= typeof formData !== 'undefined' && formData.title ? formData.title : (typeof post !== 'undefined' && post.title ? post.title : '') %>" required>
</div>

<div class="admin-form-group">
    <label for="summary">Короткий опис (для списку статей) <span class="required">*</span></label>
    <textarea id="summary" name="summary" class="admin-form-control" rows="3" required><%= typeof formData !== 'undefined' && formData.summary ? formData.summary : (typeof post !== 'undefined' && post.summary ? post.summary : '') %></textarea>
    <small>Максимум 200-250 символів. Відображається на сторінці списку статей.</small>
</div>

<div class="admin-form-group">
    <label for="content">Повний текст статті <span class="required">*</span></label>
    <textarea id="content" name="content" class="admin-form-control" rows="15" required><%= typeof formData !== 'undefined' && formData.content ? formData.content : (typeof post !== 'undefined' && post.content ? post.content : '') %></textarea>
    <small>Тут можна використовувати HTML-теги для форматування (наприклад, <strong>жирний</strong>, <em>курсив</em>, <a href="#">посилання</a>, списки ul/ol, параграфи p).</small>
</div>

<hr>
<h4>Налаштування SEO (необов'язково)</h4>

<div class="admin-form-group">
    <label for="metaTitle">Meta Title (для пошукових систем)</label>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
        <input type="text" id="metaTitle" name="metaTitle" class="admin-form-control" value="<%= typeof formData !== 'undefined' && formData.metaTitle ? formData.metaTitle : (typeof post !== 'undefined' && post.metaTitle ? post.metaTitle : '') %>" style="flex-grow: 1;">
        <button type="button" id="generateMetaTitleBtn" class="btn btn-secondary btn-sm" style="flex-shrink: 0; padding: 0.5rem 0.8rem; line-height: 1.5;" title="Згенерувати Meta Title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.646 2.472A.5.5 0 1 0 6 5.843V4.013a.5.5 0 1 0-1 0v1.829h-1.02a.5.5 0 1 0 0 1H5v1.829a.5.5 0 1 0 1 0V6.843h1.02a.5.5 0 0 0 .646-.371Z"/><path d="M.5 12.04A.5.5 0 0 0 0 12.5v1.167l1.829 1.828a.5.5 0 0 0 .707-.707L1.207 13.5h1.166a.5.5 0 0 0 .5-.5V12a.5.5 0 0 0-.5-.5H1.207l1.328-1.329a.5.5 0 0 0-.707-.707L.5 11.293V12.04Zm15 0a.5.5 0 0 0-.5-.5h-1.166l-1.329-1.329a.5.5 0 0 0-.707.707L13.5 12h-1.167a.5.5 0 0 0-.5.5v.5a.5.5 0 0 0 .5.5h1.166l1.329 1.329a.5.5 0 0 0 .707-.707L14.5 13.5v-.793a.5.5 0 0 0-.5-.5Z"/><path d="M11.469 8.242c.063.577.346 1.383.997 2.294.634.921 1.373 1.853 1.996 2.62.313.384.415.962.23 1.373-.186.412-.646.656-1.125.568-.479-.088-.894-.422-1.114-.833-.21-.396-.203-1.02.048-1.562.252-.541.65-1.334 1.043-2.062-.631-.842-1.374-1.747-2.012-2.538-.317-.395-.423-.965-.234-1.379.188-.413.648-.66-1.128-.571-.48.088-.892.423-1.11.836-.211.396-.206 1.022-.044 1.564Zm-6.938 0c-.063.577-.346 1.383-.997 2.294-.634.921-1.373 1.853-1.996 2.62-.313.384-.415.962-.23 1.373.186.412.646.656 1.125.568-.479-.088-.894-.422-1.114-.833-.21-.396-.203-1.02-.048-1.562-.252-.541-.65-1.334-1.043-2.062.631-.842 1.374-1.747 2.012-2.538-.317-.395-.423-.965-.234-1.379-.188-.413-.648-.66-1.128-.571-.48.088-.892.423-1.11.836-.211.396-.206 1.022.044 1.564Z"/><path d="M4.973 8.242a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm6.054 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/></svg>
        </button>
    </div>
    <small>Оптимальна довжина 50-60 символів. Якщо не вказано, буде використано заголовок статті.</small>
</div>

<div class="admin-form-group">
    <label for="metaDescription">Meta Description (для пошукових систем)</label>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
        <textarea id="metaDescription" name="metaDescription" class="admin-form-control" rows="3" maxlength="170" placeholder="Короткий опис для пошуку (до 160 симв.)" style="flex-grow: 1;"><%= typeof formData !== 'undefined' && formData.metaDescription ? formData.metaDescription : (typeof post !== 'undefined' && post.metaDescription ? post.metaDescription : '') %></textarea>
        <button type="button" id="generateMetaDescBtn" class="btn btn-secondary btn-sm" style="flex-shrink: 0; padding: 0.5rem 0.8rem; line-height: 1.5;" title="Згенерувати Meta Description">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.646 2.472A.5.5 0 1 0 6 5.843V4.013a.5.5 0 1 0-1 0v1.829h-1.02a.5.5 0 1 0 0 1H5v1.829a.5.5 0 1 0 1 0V6.843h1.02a.5.5 0 0 0 .646-.371Z"/><path d="M.5 12.04A.5.5 0 0 0 0 12.5v1.167l1.829 1.828a.5.5 0 0 0 .707-.707L1.207 13.5h1.166a.5.5 0 0 0 .5-.5V12a.5.5 0 0 0-.5-.5H1.207l1.328-1.329a.5.5 0 0 0-.707-.707L.5 11.293V12.04Zm15 0a.5.5 0 0 0-.5-.5h-1.166l-1.329-1.329a.5.5 0 0 0-.707.707L13.5 12h-1.167a.5.5 0 0 0-.5.5v.5a.5.5 0 0 0 .5.5h1.166l1.329 1.329a.5.5 0 0 0 .707-.707L14.5 13.5v-.793a.5.5 0 0 0-.5-.5Z"/><path d="M11.469 8.242c.063.577.346 1.383.997 2.294.634.921 1.373 1.853 1.996 2.62.313.384.415.962.23 1.373-.186.412-.646.656-1.125.568-.479-.088-.894-.422-1.114-.833-.21-.396-.203-1.02.048-1.562.252-.541.65-1.334 1.043-2.062-.631-.842-1.374-1.747-2.012-2.538-.317-.395-.423-.965-.234-1.379.188-.413.648-.66-1.128-.571-.48.088-.892.423-1.11.836-.211.396-.206 1.022-.044 1.564Zm-6.938 0c-.063.577-.346 1.383-.997 2.294-.634.921-1.373 1.853-1.996 2.62-.313.384-.415.962-.23 1.373.186.412.646.656 1.125.568-.479-.088-.894-.422-1.114-.833-.21-.396-.203-1.02-.048-1.562-.252-.541-.65-1.334-1.043-2.062.631-.842 1.374-1.747 2.012-2.538-.317-.395-.423-.965-.234-1.379-.188-.413-.648-.66-1.128-.571-.48.088-.892.423-1.11.836-.211.396-.206 1.022.044 1.564Z"/><path d="M4.973 8.242a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm6.054 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/></svg>
        </button>
    </div>
    <small>Оптимальна довжина 150-160 символів. Якщо не вказано, буде використано короткий опис статті.</small>
    <div id="metaDescCounterBlog" style="font-size: 0.8em; text-align: right; color: #6c757d; margin-top: 3px;">0 / 160</div>
</div>
<hr>

<div class="admin-form-group">
    <label for="imageFile">Головне зображення статті</label>
    <% if (typeof post !== 'undefined' && post.imageUrl) { %>
        <div class="current-image-item" style="margin-bottom: 10px;">
            <img src="<%= post.imageUrl %>?v=<%= new Date().getTime() %>" alt="Поточне зображення" style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid #ddd; padding: 5px; background: #f9f9f9;">
             <label class="checkbox-group" style="font-size: 0.9em; color: var(--color-danger); margin-top: 5px;">
                <input type="checkbox" name="deleteCurrentImage" value="true"> Видалити поточне зображення
            </label>
        </div>
    <% } %>
    <input type="file" id="imageFile" name="imageFile" class="admin-form-control" accept="image/jpeg, image/png, image/gif, image/webp">
    <small id="file-chosen-blog">Файл не вибрано. Рекомендований розмір: не менше 800x400px. Формати: JPG, PNG, GIF, WEBP.</small>
</div>

<div class="admin-form-group">
    <label for="tags">Теги (через кому)</label>
    <input type="text" id="tags" name="tags" class="admin-form-control" value="<%= typeof formData !== 'undefined' && formData.tags ? (Array.isArray(formData.tags) ? formData.tags.join(', ') : formData.tags) : (typeof post !== 'undefined' && post.tags ? post.tags.join(', ') : '') %>">
    <small>Наприклад: історія, традиції, хрестик, гладь</small>
</div>

<div class="admin-form-group checkbox-group">
    <input type="checkbox" id="isPublished" name="isPublished" <% if ((typeof formData !== 'undefined' && formData.isPublished === 'on') || (typeof post !== 'undefined' && post.isPublished)) { %>checked<% } %>>
    <label for="isPublished" style="font-weight: bold;">Опублікувати статтю</label>
    <small style="margin-left: 25px; margin-top: 0;">Якщо галочка встановлена, стаття буде видима на сайті.</small>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Для отображения имени файла после выбора
        const imageFileInputBlog = document.getElementById('imageFile');
        const fileChosenSpanBlog = document.getElementById('file-chosen-blog');
        if (imageFileInputBlog && fileChosenSpanBlog) {
            imageFileInputBlog.addEventListener('change', function(){
                fileChosenSpanBlog.textContent = this.files.length > 0 ? `Вибрано файл: ${this.files[0].name}` : 'Файл не вибрано.';
            });
        }

        // Генерация Meta Title
        const generateMetaTitleBtn = document.getElementById('generateMetaTitleBtn');
        const articleTitleInput = document.getElementById('title'); // Используем основной заголовок статьи
        const metaTitleInput = document.getElementById('metaTitle');

        if (generateMetaTitleBtn && articleTitleInput && metaTitleInput) {
            generateMetaTitleBtn.addEventListener('click', async function() {
                const articleTitle = articleTitleInput.value.trim();
                const articleSummary = document.getElementById('summary')?.value.trim() || '';
                const articleContent = document.getElementById('content')?.value.trim() || '';

                if (!articleTitle && !articleSummary && !articleContent) {
                    alert('Будь ласка, введіть заголовок, короткий опис або основний текст статті.');
                    return;
                }
                
                const originalButtonText = this.innerHTML;
                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Генеруємо...`;

                try {
                    const response = await fetch('/admin/blog/generate-meta-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ articleTitle, articleSummary, articleContent })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Помилка сервера: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.metaTitle) {
                        metaTitleInput.value = data.metaTitle;
                    }
                    // Meta Description будет заполняться другой кнопкой
                } catch (error) {
                    console.error('Помилка генерації Meta Title:', error);
                    alert(`Помилка: ${error.message}`);
                } finally {
                    this.disabled = false;
                    this.innerHTML = originalButtonText;
                }
            });
        }

        // Генерация Meta Description
        const generateMetaDescBtnBlog = document.getElementById('generateMetaDescBtn');
        const metaDescTextareaBlog = document.getElementById('metaDescription');
        const metaDescCounterBlog = document.getElementById('metaDescCounterBlog');
        const metaDescMaxLengthBlog = 160;

        function updateMetaCounterBlog() {
            if (!metaDescTextareaBlog || !metaDescCounterBlog) return;
            const currentLength = metaDescTextareaBlog.value.length;
            metaDescCounterBlog.textContent = `${currentLength} / ${metaDescMaxLengthBlog}`;
            if (currentLength > metaDescMaxLengthBlog) {
                metaDescCounterBlog.style.color = 'red';
            } else if (currentLength > metaDescMaxLengthBlog - 20) {
                metaDescCounterBlog.style.color = 'orange';
            } else {
                metaDescCounterBlog.style.color = '#6c757d';
            }
        }

        if (metaDescTextareaBlog) {
             metaDescTextareaBlog.addEventListener('input', updateMetaCounterBlog);
             updateMetaCounterBlog(); // Initial call
        }


        if (generateMetaDescBtnBlog && articleTitleInput && metaDescTextareaBlog) {
            generateMetaDescBtnBlog.addEventListener('click', async function() {
                const articleTitle = articleTitleInput.value.trim();
                const articleSummary = document.getElementById('summary')?.value.trim() || '';
                const articleContent = document.getElementById('content')?.value.trim() || '';

                if (!articleTitle && !articleSummary && !articleContent) {
                    alert('Будь ласка, введіть заголовок, короткий опис або основний текст статті.');
                    return;
                }

                const originalButtonText = this.innerHTML;
                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Генеруємо...`;

                try {
                    const response = await fetch('/admin/blog/generate-meta-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ articleTitle, articleSummary, articleContent })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Помилка сервера: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.metaDescription) {
                        metaDescTextareaBlog.value = data.metaDescription;
                        updateMetaCounterBlog();
                    }
                     if (data.metaTitle && !metaTitleInput.value) { // Заполняем Meta Title, если он пуст
                        metaTitleInput.value = data.metaTitle;
                    }
                } catch (error) {
                    console.error('Помилка генерації Meta Description:', error);
                    alert(`Помилка: ${error.message}`);
                } finally {
                    this.disabled = false;
                    this.innerHTML = originalButtonText;
                }
            });
        }
    });
</script>