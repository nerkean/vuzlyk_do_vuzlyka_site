<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.name %> - Вузлик</title>

    <meta name="description" content="<%= typeof metaDescription !== 'undefined' ? metaDescription : product.description.substring(0, 160) %>"> 

    <% if (product && product.images && product.images.length > 0) { %>
        <link 
            rel="preload" 
            fetchpriority="high" 
            as="image" 
            href="<%= product.images[0] %>"
        >
    <% } %>
    <link rel="preload" href="/fonts/roboto-v47-cyrillic_latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/montserrat-v29-cyrillic_latin-700.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/product-page.css">

    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
</head>
<body>
    <%- include('partials/header') %>

    <main class="product-page-main">
        <div class="container">
            <section class="product-main-section" data-aos="fade-up">
                <div class="product-gallery-column" data-aos="fade-right" data-aos-duration="800">
                    <div class="product-gallery">
                        <div class="main-image-container">
                            <img src="<%= product.images[0] %>" alt="<%= product.name %>" id="mainProductImage">
                        </div>
                        <% if (product.images && product.images.length > 1) { %>
                            <div class="thumbnail-list">
                                <% product.images.forEach((image, index) => { %>
                                    <div class="thumbnail-item <%= index === 0 ? 'active' : '' %>">
                                        <img src="<%= image %>" alt="Мініатюра <%= product.name %> <%= index + 1 %>" data-large="<%= image %>">
                                    </div>
                                <% }); %>
                            </div>
                        <% } %>
                    </div>
                    <div class="product-action-area">
                        <div class="product-price"><%= product.price %> грн</div>
                        <button class="btn btn-primary btn-lg add-to-cart-button" data-product-id="<%= product._id %>">
                            <i class="fa-solid fa-cart-plus"></i> Додати в кошик
                        </button>
                         <% if (product.sku === 'CUSTOM_EMBROIDERY_SKU') { %> <button class="btn btn-secondary btn-lg upload-custom-image-btn">Завантажити своє фото</button>
                            <input type="file" id="customImageUpload" style="display: none;" accept="image/*">
                         <% } %>
                    </div>
                </div>

                <div class="product-info-column" data-aos="fade-left" data-aos-duration="800" data-aos-delay="100">
                    <h1 class="product-title"><%= product.name %></h1>

                    <% if (product.status) { %>
                        <div class="product-status-info">
                            <span class="status status-<%= product.status.toLowerCase().replace(' ', '-') %>">Статус: <%= product.status %></span>
                            <% if (product.status === 'Під замовлення' && product.creation_time_info) { %>
                                <span class="creation-time">(<%= product.creation_time_info %>)</span>
                            <% } %>
                        </div>
                    <% } %>

                    <div class="product-short-specs">
                        <% if (product.dimensions && product.dimensions.size_name) { %>
                            <p><strong>Розмір:</strong> <%= product.dimensions.size_name %></p>
                        <% } %>
                        <% if (product.colors && product.colors.length > 0) { %>
                            <p><strong>Основні кольори:</strong> <%= product.colors.join(', ') %></p>
                        <% } %>
                    </div>

                    <% if (product.description) { %>
                        <div class="product-description" data-aos="fade-up" data-aos-delay="200">
                            <h2>Опис</h2>
                            <p><%= product.description %></p>
                        </div>
                    <% } %>

                    <% if (product.materials && product.materials.length > 0) { %>
                        <div class="product-materials" data-aos="fade-up" data-aos-delay="250">
                            <h2>Матеріали</h2>
                            <ul>
                                <% product.materials.forEach(material => { %>
                                    <li><%= material %></li>
                                <% }); %>
                            </ul>
                        </div>
                    <% } %>

                    <% if (product.care_instructions) { %>
                         <div class="product-care" data-aos="fade-up" data-aos-delay="300">
                            <h2>Догляд</h2>
                            <p><%= product.care_instructions %></p>
                        </div>
                    <% } %>

                    <% if (product.tags && product.tags.length > 0) { %>
                        <div class="product-tags" data-aos="fade-up" data-aos-delay="350">
                            <strong>Теги:</strong>
                            <% product.tags.forEach((tag, index) => { %>
                                <a href="/catalog?tags=<%= encodeURIComponent(tag) %>" class="tag-link"><%= tag %></a><%= (index < product.tags.length - 1) ? ',' : '' %>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </section>

            <% if (reviews && reviews.length > 0) { %>
                <section class="product-reviews-section section-padding bg-light" data-aos="zoom-in-up" data-aos-duration="600">
                    <h2 class="section-title">Відгуки Покупців</h2>
                    <div class="reviews-list">
                        <% reviews.forEach((review, index) => { %>
                            <div class="review-item">
                                <div class="review-header">
                                    <span class="review-author"><%= review.author || 'Анонім' %></span>
                                    <span class="review-date"><%= review.createdAt.toLocaleDateString('uk-UA') %></span> <div class="review-rating">
                                        <% for(let i = 0; i < 5; i++) { %>
                                            <i class="fa<%= (i < review.rating) ? 's' : 'r' %> fa-star"></i>
                                        <% } %>
                                    </div>
                                </div>
                                <p class="review-text"><%= review.text %></p>
                            </div>
                        <% }); %>
                    </div>
                </section>
            <% } %>
             <% if (similarProducts && similarProducts.length > 0) { %>
                <section class="similar-products-section section-padding" data-aos="fade-up" data-aos-duration="600">
                    <h2 class="section-title">Вам також може сподобатися</h2>
                    <div class="product-scroll-row">
                        <% similarProducts.forEach((similarProduct, index) => { %>
                            <article class="product-card" data-aos="fade-up" data-aos-delay="<%= 100 + index * 50 %>">
                                 <div class="product-image-wrapper">
                                    <a href="/product/<%= similarProduct._id %>">
                                        <img src="<%= similarProduct.images[0] %>" alt="<%= similarProduct.name %>">
                                        <div class="product-overlay"><span class="view-details-btn">Детальніше</span></div>
                                    </a>
                                </div>
                                <div class="product-info">
                                     <a href="/product/<%= similarProduct._id %>"><h3><%= similarProduct.name %></h3></a>
                                    <p class="price"><%= similarProduct.price %> грн</p>
                                    <button class="btn btn-tertiary" data-product-id="<%= similarProduct._id %>"><i class="fa-solid fa-cart-plus"></i> В кошик</button>
                                </div>
                            </article>
                        <% }); %>
                    </div>
                </section>
            <% } %>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script src="/js/main.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
     <script>
        AOS.init({ once: true, duration: 600, easing: 'ease-out-cubic', offset: 50 });

        const mainImage = document.getElementById('mainProductImage');
        const thumbnails = document.querySelectorAll('.thumbnail-item img');
        const thumbnailItems = document.querySelectorAll('.thumbnail-item');

        if (mainImage && thumbnails.length > 0) {
            thumbnails.forEach((thumbnail, index) => {
                thumbnail.addEventListener('click', () => {
                    const largeImageSrc = thumbnail.dataset.large;
                    if (largeImageSrc) {
                        mainImage.src = largeImageSrc;
                        mainImage.alt = thumbnail.alt.replace('Мініатюра', 'Фото');
                        thumbnailItems.forEach(item => item.classList.remove('active'));
                        if (thumbnailItems[index]) {
                            thumbnailItems[index].classList.add('active');
                        }
                    }
                });
            });
        } else if (mainImage && thumbnails.length === 0) {
             const thumbnailList = document.querySelector('.thumbnail-list');
             if (thumbnailList) {
                thumbnailList.style.display = 'none';
             }
        }

     </script>
</body>
</html>
