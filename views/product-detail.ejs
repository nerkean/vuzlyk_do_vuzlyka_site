<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <%
        let pageTitle = `${product.name}`;
        if (product.category && product.category !== 'Вишивка') { 
            pageTitle += ` (${product.category})`;
        }
        pageTitle += ` - Купити Вишивку Ручної Роботи | Вузлик`;
        
        let mainImageUrl = '/images/og-image.jpg'; 
        if (product.images && product.images.length > 0 && product.images[0].large) {
             const baseUrl = process.env.BASE_URL || 'https://vuzlyk.com';
             mainImageUrl = new URL(product.images[0].large, baseUrl).href;
        }
        const canonicalUrl = `${process.env.BASE_URL || 'https://vuzlyk.com'}/product/${product._id}`;
    %>

    <title><%= pageTitle %></title>
    <meta name="description" content="<%= metaDescription %>">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="<%= canonicalUrl %>" />

    <meta property="og:title" content="<%= pageTitle %>">
    <meta property="og:description" content="<%= metaDescription %>">
    <meta property="og:image" content="<%= mainImageUrl %>">
    <meta property="og:url" content="<%= canonicalUrl %>">
    <meta property="og:type" content="product">
    <meta property="og:site_name" content="Вузлик до вузлика">
    <meta property="product:price:amount" content="<%= product.price %>"> 
    <meta property="product:price:currency" content="UAH"> 

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= pageTitle %>">
    <meta name="twitter:description" content="<%= metaDescription %>">
    <meta name="twitter:image" content="<%= mainImageUrl %>">

    <% if (locals.isProduction && locals.gaMeasurementId) { %>
        <script async src="https://www.googletagmanager.com/gtag/js?id=<%= locals.gaMeasurementId %>"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', '<%= locals.gaMeasurementId %>');
        </script>
    <% } else { %>
        <% } %>

    <link rel="icon" type="image/png" href="/images/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/images/favicon/site.webmanifest" />

    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin> 

    <% if (product.images && product.images.length > 0 && product.images[0].medium) { %>
        <link rel="preload" as="image" href="<%= product.images[0].medium %>" imagesrcset="<%= product.images[0].thumb %> 300w, <%= product.images[0].medium %> 600w, <%= product.images[0].large %> 1000w" imagesizes="(max-width: 768px) 90vw, (max-width: 992px) 40vw, 500px">
    <% } %>
    <link rel="preload" href="/fonts/roboto-v47-cyrillic_latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/montserrat-v29-cyrillic_latin-700.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="/css/common.css">

    <link rel="preload" href="/css/product-page.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/product-page.css"></noscript>

    <link rel="preload" href="https://unpkg.com/aos@next/dist/aos.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css"></noscript>

    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" /></noscript>

</head>
<body>
    <%- include('partials/header') %>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%- product.name %>",
      "description": "<%- product.description %>",
      <% if (product.images && product.images.length > 0 && product.images[0].large) { %>
      "image": [
         "<%= new URL(product.images[0].large, process.env.BASE_URL || 'https://vuzlyk.com').href %>"
         <% product.images.slice(1).forEach(img => { if(img.large) { %>,"<%= new URL(img.large, process.env.BASE_URL || 'https://vuzlyk.com').href %>"<% }}); %>
      ],
      <% } else { %>
       "image": ["<%= new URL('/images/placeholder.png', process.env.BASE_URL || 'https://vuzlyk.com').href %>"],
      <% } %>
      <% if (product.sku) { %> "sku": "<%= product.sku %>", <% } %>
      "brand": {
        "@type": "Organization",
        "name": "Вузлик до вузлика"
      },
      <% if (reviews && reviews.length > 0 && averageRating > 0 && ratingCount > 0) { %>
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "<%= averageRating.toFixed(1) %>",
        "reviewCount": "<%= ratingCount %>"
      },
      "review": [
        <% reviews.forEach((review, index) => { %>
          {
            "@type": "Review",
            "author": {
              "@type": "Person",
              "name": "<%- (review.userId && review.userId.name) ? review.userId.name : 'Анонім' %>"
            },
            "datePublished": "<%= review.createdAt.toISOString().split('T')[0] %>",
            <% if (review.text) { %>"reviewBody": "<%- review.text %>",<% } %>
            "reviewRating": {
              "@type": "Rating",
              "ratingValue": "<%= review.rating %>"
            }
          }<% if (index < reviews.length - 1) { %>,<% } %>
        <% }); %>
      ],
     <% } %>
     <%
        const schemaCurrency = selectedCurrency || 'UAH';
        const schemaRate = exchangeRates[schemaCurrency] || 1;
        const schemaPrice = (product.price * schemaRate).toFixed(2);
        const schemaMaxPrice = (product.maxPrice && product.maxPrice > product.price) ? (product.maxPrice * schemaRate).toFixed(2) : null;
     %>
      "offers": {
        "@type": "Offer",
        "url": "<%= canonicalUrl %>",
        <% if (schemaMaxPrice) { %>
            "priceSpecification": {
                "@type": "UnitPriceSpecification",
                "priceCurrency": "<%= schemaCurrency %>",
                "minPrice": "<%= schemaPrice %>",
                "maxPrice": "<%= schemaMaxPrice %>"
            },
        <% } else { %>
            "priceCurrency": "<%= schemaCurrency %>",
            "price": "<%= schemaPrice %>",
        <% } %>
        "availability": "https://schema.org/PreOrder", 
        "itemCondition": "https://schema.org/NewCondition"
      }
      <% if (product.materials && product.materials.length > 0) { %>, "material": "<%- product.materials.join(', ') %>" <% } %>
      <% if (product.colors && product.colors.length > 0) { %>, "color": "<%- product.colors.join(', ') %>" <% } %>
    }
    </script>
    <main class="product-page-main">
        <div class="container">
            <section class="product-main-section" data-aos="fade-up">
                <div class="product-gallery-column" data-aos="fade-right" data-aos-duration="800">
                    <div class="product-gallery">
                        <div class="main-image-container">
                            <% if (product.images && product.images.length > 0 && product.images[0].large) { %>
                                <img id="mainProductImage"
                                srcset="<%= product.images[0].thumb %> 300w,
                                        <%= product.images[0].medium %> 600w,
                                        <%= product.images[0].large %> 1000w"
                                sizes="(max-width: 768px) 90vw, (max-width: 992px) 40vw, 500px" <%# Скорректировал sizes %>
                                src="<%= product.images[0].medium %>"
                                fetchpriority="high"
                                alt="Фото <%= product.name %> - головне зображення"
                                width="600" height="700"> 
                            <% } else { %>
                                <img id="mainProductImage" src="/images/placeholder.png" alt="Зображення відсутнє для <%= product.name %>" width="600" height="700">
                            <% } %>
                        </div>
                        <% if (product.images && product.images.length > 1) { %>
                            <div class="thumbnail-list">
                                <% product.images.forEach((imageSet, index) => { %>
                                    <% if (imageSet.thumb && imageSet.medium && imageSet.large) { %>
                                        <div class="thumbnail-item <%= index === 0 ? 'active' : '' %>">
                                            <img src="<%= imageSet.thumb %>"
                                                 alt="Мініатюра <%= product.name %> <%= index + 1 %>"
                                                 data-large="<%= imageSet.large %>"
                                                 data-medium="<%= imageSet.medium %>"
                                                 data-thumb="<%= imageSet.thumb %>"
                                                 width="80" height="95" loading="lazy">
                                        </div>
                                    <% } %>
                                <% }); %>
                            </div>
                        <% } %>
                    </div>
                     <div class="product-action-area">
                        <div class="product-price" >
                            <% if (product.maxPrice && product.maxPrice > product.price) { %>
                                <%= formatPrice(product.price, selectedCurrency, exchangeRates, currencySymbols) %> - <%= formatPrice(product.maxPrice, selectedCurrency, exchangeRates, currencySymbols) %>
                                <span class="price-note" style="display: block; font-size: 0.7em; color: var(--color-text-light); margin-top: -5px;">(ціна залежить від складності)</span>
                            <% } else { %>
                                <%= formatPrice(product.price, selectedCurrency, exchangeRates, currencySymbols) %>
                            <% } %>
                        </div>
                       <div class="product-rating-display" >
                            <% const avgRating = typeof averageRating !== 'undefined' ? averageRating : 0; %>
                            <% const ratingCountVal = typeof ratingCount !== 'undefined' ? ratingCount : 0; %>
                            <div class="stars" aria-label="Рейтинг: <%= avgRating.toFixed(1) %> з 5"> 
                                <% for(let i = 1; i <= 5; i++) { %>
                                    <% if (i <= avgRating) { %><i class="fas fa-star" aria-hidden="true"></i>
                                    <% } else if (i - 0.5 <= avgRating) { %><i class="fas fa-star-half-alt" aria-hidden="true"></i>
                                    <% } else { %><i class="far fa-star" aria-hidden="true"></i>
                                    <% } %>
                                <% } %>
                            </div>
                            <% if (ratingCountVal > 0) { %>
                                <span class="rating-value"><%= avgRating.toFixed(1) %> / 5</span>
                                <span class="rating-count">(<%= ratingCountVal %> <%= ratingCountVal === 1 ? 'відгук' : (ratingCountVal >= 2 && ratingCountVal <= 4 ? 'відгуки' : 'відгуків') %>)</span>
                            <% } else { %>
                                <span class="rating-value">Ще немає відгуків</span>
                            <% } %>
                        </div>

                        <button class="btn btn-primary btn-lg add-to-cart-button" data-product-id="<%= product._id %>">
                            <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                            Додати в кошик </button>
                         <p style="font-size: 0.9em; margin-top: 10px; color: #6c757d;">Ми зв'яжемося для уточнення деталей</p>
                    </div>
                </div>

                <div class="product-info-column" data-aos="fade-left" data-aos-duration="800" data-aos-delay="100">
                    <h1 class="product-title"><%= product.name %></h1> 

                    <div class="product-status-info">
                       <span class="status status-<%= product.status.toLowerCase().replace(' ', '-') %>"><%= product.status %></span>
                       <% if (product.creation_time_info) { %>
                          <span class="creation-time">(Термін виготовлення: <%= product.creation_time_info %> робочих днів)</span>
                       <% } %>
                   </div>

                   <div class="product-short-specs">
                       <% if (product.dimensions && product.dimensions.size_name) { %><p><strong>Розмір:</strong> <%= product.dimensions.size_name %></p><% } %>
                       <% if (product.colors && product.colors.length > 0) { %><p><strong>Основні кольори:</strong> <%= product.colors.join(', ') %></p><% } %>
                       <% if (product.sku) { %><p><strong title="Артикул">SKU:</strong> <%= product.sku %></p><% } %> 
                    </div>

                    <% if (product.description) { %>
                    <div class="product-description" data-aos="fade-up" data-aos-delay="200">
                        <h2>Опис товару</h2> <%# H2 для секции %>
                        <div itemprop="description"><%- product.description.replace(/\n/g, '<br>') %></div> <%# Добавил itemprop %>
                    </div>
                    <% } %>

                    <% if (product.materials && product.materials.length > 0) { %>
                    <div class="product-materials" data-aos="fade-up" data-aos-delay="250">
                        <h2>Матеріали</h2> <%# H2 для секции %>
                        <ul><% product.materials.forEach(material => { %><li><%= material %></li><% }); %></ul>
                    </div>
                    <% } %>

                    <% if (product.care_instructions) { %>
                    <div class="product-care" data-aos="fade-up" data-aos-delay="300">
                        <h2>Догляд</h2> <%# H2 для секции %>
                        <p><%= product.care_instructions %></p>
                    </div>
                    <% } %>

                    <% if (product.tags && product.tags.length > 0) { %>
                    <div class="product-tags" data-aos="fade-up" data-aos-delay="350">
                        <strong>Теги:</strong>
                        <% product.tags.forEach((tag, index) => { %>
                           <a href="/catalog?tags=<%= encodeURIComponent(tag) %>" class="tag-link"><%= tag %></a>
                        <% }); %>
                    </div>
                    <% } %>
                </div>
            </section>

            <section class="product-reviews-section section-padding bg-light" data-aos="fade-up">
                <h2 class="section-title text-center">Відгуки Покупців</h2> <%# H2 для секции %>

                 <% if (currentUser && canReview && !hasReviewed) { %>
                   <div class="leave-review-prompt" style="text-align: center; margin-bottom: 30px;">
                      <p>Ви придбали цей товар. Поділіться своїм враженням!</p>
                      <a href="/product/<%= product._id %>/review" class="btn btn-secondary">Залишити відгук</a>
                  </div>
               <% } else if (currentUser && hasReviewed) { %>
                  <div class="leave-review-prompt" style="text-align: center; margin-bottom: 30px;">
                     <p style="color: #198754;">Дякуємо за ваш відгук!</p>
                  </div>
               <% } else if (currentUser && !canReview) { %>
                   <div class="leave-review-prompt" style="text-align: center; margin-bottom: 30px;">
                       <p style="font-style: italic; color: #6c757d;">Ви зможете залишити відгук після покупки та виконання замовлення.</p>
                   </div>
               <% } else if (!currentUser) { %>
                  <div class="leave-review-prompt" style="text-align: center; margin-bottom: 30px;">
                      <p><a href="/login?redirect=/product/<%= product._id %>">Увійдіть</a> або <a href="/register?redirect=/product/<%= product._id %>">зареєструйтесь</a>, щоб залишити відгук.</p>
                  </div>
               <% } %>

                <div class="reviews-list" id="reviewsList">
                    <% if (typeof reviews !== 'undefined' && reviews && reviews.length > 0) { %>
                        <% reviews.forEach((review, index) => { %>
                            <article class="review-item" data-aos="fade-up" data-aos-delay="<%= index * 50 %>" >
                                <header class="review-header">
                                    <span class="review-author"><%= (review.userId && review.userId.name) ? review.userId.name : 'Анонім' %></span>
                                    <div class="review-rating" aria-label="Оцінка: <%= review.rating %> з 5">
                                        <% for(let i = 1; i <= 5; i++) { %><i class="<%= i <= review.rating ? 'fas' : 'far' %> fa-star" aria-hidden="true"></i><% } %>
                                    </div>
                                    <span class="review-date" datetime="<%= review.createdAt.toISOString().split('T')[0] %>"><%= new Date(review.createdAt).toLocaleDateString('uk-UA') %></span>
                                </header>
                                <% if(review.text) { %>
                                <blockquote class="review-text">
                                    <div><%- review.text.replace(/\n/g, '<br>') %></div>
                                </blockquote>
                                <% } %>
                            </article>
                        <% }); %>
                    <% } else { %>
                        <p class="no-reviews-message">Для цього товару ще немає відгуків.</p>
                    <% } %>
                </div>
            </section>

             <% if (typeof similarProducts !== 'undefined' && similarProducts && similarProducts.length > 0) { %>
               <section class="similar-products-section section-padding" data-aos="fade-up" data-aos-duration="600">
                 <h2 class="section-title">Вам також може сподобатися</h2> 
                 <div class="product-scroll-row">
                    <% similarProducts.forEach((similarProduct, index) => { %>
                       <article class="product-card" data-aos="fade-up" data-aos-delay="<%= 100 + index * 50 %>">
                          <div class="product-image-wrapper">
                             <a href="/product/<%= similarProduct._id %>" aria-label="Переглянути деталі товару <%= similarProduct.name %>">
                                <%
                                    let simImgSrc = '/images/placeholder.png';
                                    if (similarProduct.images && similarProduct.images.length > 0) {
                                        simImgSrc = similarProduct.images[0].medium || similarProduct.images[0].thumb || simImgSrc;
                                    }
                                %>
                                <img src="<%= simImgSrc %>"
                                     alt="<%= similarProduct.name %> - Схожий товар"
                                     width="300" height="400" loading="lazy"
                                     onerror="this.onerror=null; this.src='/images/placeholder.png';">
                                <div class="product-overlay"><span class="view-details-btn">Детальніше</span></div>
                             </a>
                          </div>
                          <div class="product-info">
                              <a href="/product/<%= similarProduct._id %>"><h3><%= similarProduct.name %></h3></a>
                             <p class="price">
                                <% if (similarProduct.maxPrice && similarProduct.maxPrice > similarProduct.price) { %>
                                   <%= formatPrice(similarProduct.price, selectedCurrency, exchangeRates, currencySymbols) %> - <%= formatPrice(similarProduct.maxPrice, selectedCurrency, exchangeRates, currencySymbols) %>
                               <% } else { %>
                                   <%= formatPrice(similarProduct.price, selectedCurrency, exchangeRates, currencySymbols) %>
                               <% } %>
                             </p>
                              <button class="btn btn-tertiary add-to-cart-button" data-product-id="<%= similarProduct._id %>" aria-label="Додати <%= similarProduct.name %> в кошик">
                                <svg class="icon icon-cart-plus" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96zM252 160c0 11 9 20 20 20l44 0 0 44c0 11 9 20 20 20s20-9 20-20l0-44 44 0c11 0 20-9 20-20s-9-20-20-20l-44 0 0-44c0-11-9-20-20-20s-20 9-20 20l0 44-44 0c-11 0-20 9-20 20z"/>
                                </svg>
                                  В кошик </button>
                          </div>
                       </article>
                   <% }); %>
                 </div>
               </section>
            <% } %>

        </div>
    </main>

    <%- include('partials/footer') %>

    <script src="/js/main.js" defer></script>
    <script src="/js/product-page.js" defer></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js" defer></script> 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
             const initAOS = () => {
                 if (typeof AOS !== 'undefined') {
                     AOS.init({
                         once: true,
                         duration: 600,
                         easing: 'ease-out-cubic',
                         offset: 50
                     });
                 } 
             };
             initAOS(); 
         });
    </script>
</body>
</html>